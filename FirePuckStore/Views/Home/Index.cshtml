@model IDictionary<string, List<FirePuckStore.Models.Card>>
@{
    ViewBag.Title = "Store";
}
@{
    Html.RenderAction("Details", "Cart");
}
<div id="categorySection" class="ui-accordion ui-widget ui-helper-reset">
    @{
        foreach (var category in Model)
        {
        <h3>
            <a href="#">@category.Key</a></h3>
        <div>
            @foreach (var card in category.Value)
            {
                <div class="cartItem">
                    <img cardid = "@card.CardId"  src="@card.ImageUrl" alt="@card.Description" @(card.Quantity > 0 ? "draggable=true" : "draggable=false class = noItemsInStore") />
@*
                    <div class = "cardDescription" style="display: none">
                        <p>@card.Description</p>
                    </div>
*@
                        @{

                            if (card.Quantity > 0)
                            {
                                <br />
                                <h6>
                                    Qnty:</h6>
                                <span>@card.Quantity</span>
                                <br />
                                <h6>
                                    Price:</h6>
                                <span>@card.Price</span>
                            }
                            else
                            {
                                <br />                        
                                <h6>
                                    Not in stock</h6>                        
                                <br />                        
                                <h6 />
                            }
                        }
                    </div>
            }
        </div>
        }
    }
</div>
@section Scripts
{
    <script type="text/javascript">
        var draggedID;

        function handleDrag(e) {
            e.preventDefault();
        }

        function subscribeAtDragDropEvents() {

            var shoppingCart = document.getElementById("shoppingCart");
            shoppingCart.ondragenter = handleDrag;
            shoppingCart.ondragover = handleDrag;
            shoppingCart.ondrop = function (e) {

                /*var newElem =$("img[cardid~=" + draggedID + "]").first().cloneNode(false);*/

                var card = { CardId: draggedID };

                /*var json = $.toJSON(card);*/

                $.ajax({
                    url: '/Cart/Add',
                    type: 'POST',
                    data: card,
                    success: function (data) {
                        $("aside").replaceWith(data);
                        subscribeAtDragDropEvents();
                        subscribeAtCardClickEvent();
                        var cards = $("img[cardid~=" + draggedID + "]");
                        var quantites = cards.parent().find("span:first");
                        var oldQuantity = quantites.first().text();
                        var newQuantity = oldQuantity - 1;
                        if (newQuantity == 0) {
                            var noStockHtml = $("<br/><h6>Not in stock</h6><br /><h6 />");
                            cards.attr('draggable',"false");
                            cards.addClass('noItemsInStore');
                            cards.nextAll().remove();
                            cards.parent().append(noStockHtml);
                            return;
                        }

                        quantites.each(function () {
                            $(this).text(newQuantity);
                        });

                        /*
                        var cardEl = document.getElementById(draggedID);
                        var quantity = $(cardEl.parentElement).find("span:first");
                        */

                        // get the result and do some magic with it
                        /*
                        newElem.classList.add("cartImg");
                        var $cart = $("<div class='cartItem'></div>");
                        $cart.append(newElem);
                        var $price = $("<br/><h6>Qnty:</h6><span> " + data.Quantity + "</span><br/><h6>Price:</h6><span>" + data.Price + "</span>");
                        $cart.append($price);
                        shoppingCart.appendChild($cart[0]);
                        */

                    }
                });
            };
        }

        function subscribeAtCardClickEvent() {
            $(".cartImg").bind('click', function (e) {
                var card = { CardId: $(e.target).attr("ordercardid") };
                $.ajax({
                    url: '/Cart/Delete',
                    type: 'POST',
                    data: card,
                    success: function (data) {
                        $("aside").replaceWith(data);
                        subscribeAtDragDropEvents();
                        subscribeAtCardClickEvent();

                        var cards = $("img[cardid~=" + card.CardId + "]");
                        if (cards.first().hasClass('noItemsInStore')) {
                            var quantity = parseInt($(e.target).parent().find(".pricequantity").text());
                            var price = $(e.target).parent().find(".pricelabel").text();
                            var pricePerItem = (parseFloat(price) / quantity).toFixed(2);
                            var noStockHtml = $("<br/><h6>Qnty:</h6><span> 1</span><br/><h6>Price:</h6><span> " + pricePerItem + "</span>");

                            cards.attr('draggable', "true");
                            cards.removeClass('noItemsInStore');
                            cards.nextAll().remove();
                            cards.parent().append(noStockHtml);
                            return;
                        }

                        var quantites = cards.parent().find("span:first");
                        var oldQuantity = quantites.first().text();
                        var newQuantity = parseInt(oldQuantity) + 1;
                        quantites.each(function () {
                            $(this).text(' ' + newQuantity);
                        });
                    }
                });
            });
        }

        $(document).ready(function () {
            $("#categorySection").accordion({ active: true });
            subscribeAtCardClickEvent();
            /*
            $('.cardDescription').dialog({
            modal: false,
            autoOpen: false,
            resizable: false
            });*/

            /*            $('.cardImg').mouseenter(function (e) {

            var cardDescription = $(this.parentElement).find(".cardDescription");
            cardDescription.fadeIn('slow', function () {
            // Animation complete
            });
            e.preventDefault();
            });

            $('.cardImg').mouseout(function (e) {

            /*  alert('leave');#1#
            var cardDescription = $(this.parentElement).find(".cardDescription");
            cardDescription.fadeOut('slow', function () {
            // Animation complete
            });
            e.preventDefault();
            });*/


            var src = document.getElementById("categorySection");
            src.ondragstart = function (e) {
                draggedID = $(e.target).attr("cardid");
                e.target.classList.add("dragged");
            };

            /*
            $(".cartImg").each(function() {
            this.ondragstart = function (e) {
            alert('dragstart');
            };
            });
            */

            /*var shoppingCart = $('#shoppingCart');*/
            /*            var shoppingCart = document.getElementById("shoppingCart");
            shoppingCart.ondragenter = handleDrag;
            shoppingCart.ondragover = handleDrag;
            shoppingCart.ondrop = function (e) {
            var newElem = document.getElementById(draggedID).cloneNode(false);

            var card = { CardId: draggedID };

            /*var json = $.toJSON(card);#1#

            $.ajax({
            url: '/Cart/Add',
            type: 'POST',
            data: card,
            success: function (data) {
            $("aside").replaceWith(data);
            // get the result and do some magic with it
            /*
            newElem.classList.add("cartImg");
            var $cart = $("<div class='cartItem'></div>");
            $cart.append(newElem);
            var $price = $("<br/><h6>Qnty:</h6><span> " + data.Quantity + "</span><br/><h6>Price:</h6><span>" + data.Price + "</span>");
            $cart.append($price);
            shoppingCart.appendChild($cart[0]);
            #1#

            }
            });
            /*
            newElem.classList.add("cartImg");
            var $cart = $("<div class='cartItem'></div>");
            $cart.append(newElem);
            var $price = $("<br/><h6>Qnty:</h6><span> 3</span><br/><h6>Price:</h6><span> 25,70</span>");
            $cart.append($price);
            shoppingCart.appendChild($cart[0]);
                
            #1#
            e.preventDefault();
            };*/

            subscribeAtDragDropEvents();
        });

    </script>
}
